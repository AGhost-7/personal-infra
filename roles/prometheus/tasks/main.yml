- name: create config directory
  loop:
    - prometheus
    - blackbox_exporter
    - alertmanager
  file:
    state: directory
    path: /var/containers/{{item}}/config

- name: ensure prometheus config file exists
  file:
    state: touch
    path: /var/containers/prometheus/config/prometheus.yml

- name: create rules directory
  file:
    state: directory
    path: /var/containers/prometheus/rules

- name: open up firewall
  ufw:
    rule: allow
    direction: in
    interface: lo
    port: 9090
  notify:
    - "reload firewall"

- name: create prometheus container
  docker_container:
    name: prometheus
    pull: True
    # Use json-file since we need prometheus to monitor the elasic logger. They
    # shouldn't be interdependent in case elastic fails.
    log_driver: json-file
    image: prom/prometheus
    command: "--config.file=/etc/prometheus/config/prometheus.yml"
    network_mode: host
    restart_policy: unless-stopped
    volumes:
      - /var/containers/prometheus/prometheus:/prometheus
      - /var/containers/prometheus/config:/etc/prometheus/config
      - /var/containers/prometheus/rules:/etc/prometheus/rules

- name: generate prometheus config
  template:
    src: prometheus.yml.j2
    dest: /var/containers/prometheus/config/prometheus.yml
  notify:
    - "reload prometheus"

- name: copy prometheus rules config
  copy:
    src: file/rules.yml
    dest: /var/containers/prometheus/rules/rules.yml
  notify:
    - "reload prometheus"

- name: create alertmanager container
  docker_container:
    name: alertmanager
    image: prom/alertmanager:v0.17.0
    log_driver: json-file
    network_mode: host
    restart_policy: always
    volumes:
      - /var/containers/alertmanager/config:/config
      - /var/containers/alertmanager/templates:/templates
    command: "--config.file=/config/alertmanager.yml"

- name: generate alertmanager config
  template:
    src: alertmanager.yml.j2
    dest: /var/containers/alertmanager/config/alertmanager.yml
  notify:
    - "reload alertmanager"

- name: create email template directory
  file:
    state: directory
    path: /var/containers/alertmanager/templates

- name: bring up the blackbox exporter
  docker_container:
    name: blackbox_exporter
    log_driver: json-file
    image: prom/blackbox-exporter:v0.14.0
    network_mode: host
    restart_policy: always
    volumes:
      - /var/containers/blackbox_exporter/config:/config
    command: "--config.file=/config/blackbox.yml"

- name: generate blackbox config
  template:
    src: blackbox.yml.j2
    dest: /var/containers/blackbox_exporter/config/blackbox.yml
  notify:
    - "reload blackbox_exporter"
# TODO: Will need to leverage prometheus to check application status:
# https://github.com/prometheus/blackbox_exporter
# Alerts can be done from prometheus...
